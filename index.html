<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Simulateur de Trading</title>
<style>
:root{
  --bg:#0b0f14;
  --panel:#121823;
  --card:#161d2b;
  --text:#e6e9ef;
  --muted:#8b93a7;
  --blue:#3aa0ff;
  --green:#2ecc71;
  --red:#e74c3c;
}
*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text);overflow:hidden}
#app{display:flex;height:100%}
aside{width:340px;background:var(--panel);padding:12px;display:flex;flex-direction:column;gap:10px}
main{flex:1;padding:12px;display:flex;flex-direction:column;gap:10px}
.card{background:var(--card);border-radius:12px;padding:12px}
h3{margin:0 0 6px 0;font-size:14px;color:#cfd6e6}
.small{font-size:12px;color:var(--muted)}
.row{display:flex;justify-content:space-between;align-items:center;gap:8px}
.portfolio strong{font-size:18px}
.search input{width:100%;padding:8px;border-radius:8px;border:0;background:#0f1522;color:var(--text)}
.list{flex:1;overflow:auto}
.company{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;border-radius:8px;cursor:pointer}
.company:hover{background:#1b2436}
.company.active{outline:1px solid var(--blue)}
.btn{width:28px;height:28px;border-radius:50%;border:0;color:#fff;cursor:pointer}
.buy{background:var(--green)}
.sell{background:var(--red)}
.tabs{display:flex;gap:8px}
.tab{padding:8px 12px;border-radius:8px;background:#0f1522;cursor:pointer}
.tab.active{background:var(--blue)}
.canvas-wrap{flex:1;position:relative}
canvas{width:100%;height:100%;background:#0f1522;border-radius:12px}
.info{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.table{width:100%;border-collapse:collapse;font-size:12px}
.table th,.table td{padding:6px;border-bottom:1px solid #1f2a3d;text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.toggle{display:flex;align-items:center;gap:8px}
.toggle input{accent-color:var(--blue)}
.green{color:var(--green)}
.red{color:var(--red)}
</style>
</head>
<body>
<div id="app">
<aside>
  <div class="card portfolio">
    <h3>Portefeuille</h3>
    <div class="row"><span>Capital</span><strong id="capital"></strong></div>
    <div class="row"><span>Valeur totale</span><strong id="total"></strong></div>
    <div class="row"><span>Gain latent</span><strong id="latent"></strong></div>
  </div>
  <div class="card search">
    <input id="search" placeholder="Rechercher une entreprise..." />
  </div>
  <div class="card list" id="list"></div>
</aside>
<main>
  <div class="tabs">
    <div class="tab active" data-tab="chart">Graphique</div>
    <div class="tab" data-tab="stats">Stats</div>
    <div class="tab" data-tab="ai">IA / Auto</div>
  </div>

  <div class="card canvas-wrap" id="chartTab">
    <canvas id="chart"></canvas>
    <div class="info small" id="chartInfo"></div>
  </div>

  <div class="card" id="statsTab" style="display:none">
    <table class="table" id="statsTable"></table>
  </div>

  <div class="card" id="aiTab" style="display:none">
    <div class="row">
      <div>
        <div id="aiSuggestion"></div>
        <div class="small" id="aiDetails"></div>
      </div>
      <label class="toggle">
        <input type="checkbox" id="autoToggle"/> Auto
      </label>
    </div>
  </div>
</main>
</div>

<script>
(()=>{

const STORE='sim-trading-v1';
const TICK=450;
const MAX_POINTS=60;

const rnd=(a,b)=>a+Math.random()*(b-a);

const makeCompanies=()=>{
  const sectors=['Tech','Energie','Santé','Finance','Transport','Industriel'];
  return Array.from({length:50},(_,i)=>({
    name:`${sectors[i%sectors.length]}Corp ${i+1}`,
    price:rnd(10,200),
    volatility:rnd(0.002,0.02),
    shares:0,
    averagePrice:0,
    history:[],
    buys:[],
    realizedGain:0
  }));
};

let state=JSON.parse(localStorage.getItem(STORE))||{
  capital:2000,
  companies:makeCompanies(),
  selected:0,
  auto:false
};

const $=id=>document.getElementById(id);
const ctx=$('chart').getContext('2d');

const save=()=>localStorage.setItem(STORE,JSON.stringify(state));

const portfolioValue=()=>{
  let v=state.capital;
  state.companies.forEach(c=>v+=c.shares*c.price);
  return v;
};

const latentGain=c=>(c.price-c.averagePrice)*c.shares;

const updatePrices=()=>{
  state.companies.forEach(c=>{
    const change=1+rnd(-c.volatility,c.volatility);
    c.price=Math.max(0.01,c.price*change);
    c.history.push(c.price);
    if(c.history.length>MAX_POINTS*3)c.history.shift();
  });
};

const buy=c=>{
  if(state.capital>=c.price){
    state.capital-=c.price;
    c.averagePrice=(c.averagePrice*c.shares+c.price)/(c.shares+1);
    c.shares++;
    c.buys.push({price:c.price,idx:c.history.length-1});
    save();
  }
};

const sell=c=>{
  if(c.shares>0){
    state.capital+=c.price;
    c.realizedGain+=(c.price-c.averagePrice);
    c.shares--;
    if(c.shares===0)c.averagePrice=0;
    save();
  }
};

const renderList=()=>{
  const q=$('search').value.toLowerCase();
  const list=$('list');
  list.innerHTML='';
  [...state.companies]
    .filter(c=>c.name.toLowerCase().includes(q))
    .sort((a,b)=>b.shares-a.shares)
    .forEach((c,i)=>{
      const idx=state.companies.indexOf(c);
      const d=document.createElement('div');
      d.className='company'+(idx===state.selected?' active':'');
      d.onclick=()=>{state.selected=idx;renderAll()};
      d.innerHTML=`
        <div>
          <div>${c.name}</div>
          <div class="small">${c.price.toFixed(2)} € | ${c.shares} parts</div>
        </div>
        <button class="btn buy">+</button>
        <button class="btn sell">−</button>`;
      d.querySelector('.buy').onclick=e=>{e.stopPropagation();buy(c)};
      d.querySelector('.sell').onclick=e=>{e.stopPropagation();sell(c)};
      list.appendChild(d);
    });
};

const renderPortfolio=()=>{
  $('capital').textContent=state.capital.toFixed(2)+' €';
  $('total').textContent=portfolioValue().toFixed(2)+' €';
  const g=state.companies.reduce((s,c)=>s+latentGain(c),0);
  const el=$('latent');
  el.textContent=g.toFixed(2)+' €';
  el.className=g>=0?'green':'red';
};

const drawChart=()=>{
  const c=state.companies[state.selected];
  const w=ctx.canvas.width=ctx.canvas.clientWidth;
  const h=ctx.canvas.height=ctx.canvas.clientHeight;
  ctx.clearRect(0,0,w,h);
  const data=c.history.slice(-MAX_POINTS);
  if(data.length<2)return;
  let min=Math.min(...data),max=Math.max(...data);
  const pad=(max-min)*0.2||1;
  min-=pad;max+=pad;
  const x=i=>i/(MAX_POINTS-1)*w;
  const y=v=>h-(v-min)/(max-min)*h;
  ctx.strokeStyle='var(--blue)';
  ctx.beginPath();
  data.forEach((v,i)=>{i?ctx.lineTo(x(i),y(v)):ctx.moveTo(x(i),y(v))});
  ctx.stroke();
  // current price line
  ctx.strokeStyle='#fff2';
  ctx.beginPath();ctx.moveTo(0,y(c.price));ctx.lineTo(w,y(c.price));ctx.stroke();
  // buy points
  ctx.fillStyle='var(--green)';
  c.buys.forEach(b=>{
    const i=data.length-(c.history.length-b.idx);
    if(i>=0&&i<MAX_POINTS){
      ctx.beginPath();
      ctx.arc(x(i),y(b.price),4,0,Math.PI*2);
      ctx.fill();
    }
  });
};

const renderChartInfo=()=>{
  const c=state.companies[state.selected];
  $('chartInfo').innerHTML=`
    <div>${c.name}</div>
    <div>${c.price.toFixed(2)} €</div>
    <div>Moyenne ${c.averagePrice.toFixed(2)} €</div>
    <div>${c.shares} parts</div>
    <div class="${latentGain(c)>=0?'green':'red'}">${latentGain(c).toFixed(2)} €</div>`;
};

const renderStats=()=>{
  const t=$('statsTable');
  t.innerHTML='<tr><th>Entreprise</th><th>Réalisé</th><th>Latent</th><th>Total</th></tr>';
  [...state.companies]
    .map(c=>({
      c,
      latent:latentGain(c),
      total:c.realizedGain+latentGain(c)
    }))
    .sort((a,b)=>b.total-a.total)
    .forEach(o=>{
      t.innerHTML+=`
        <tr>
          <td>${o.c.name}</td>
          <td>${o.c.realizedGain.toFixed(2)}</td>
          <td>${o.latent.toFixed(2)}</td>
          <td>${o.total.toFixed(2)}</td>
        </tr>`;
    });
};

const aiAnalyze=()=>{
  const c=state.companies[state.selected];
  const h=c.history.slice(-10);
  if(h.length<2)return null;
  const slope=h[h.length-1]-h[0];
  const vol=c.volatility*100;
  const momentum=slope/h[0]*100;
  let action='ATTENDRE';
  if(momentum>0.3&&vol<1.5)action='ACHETER';
  if(momentum<-0.3)action='VENDRE';
  return {action,momentum,vol};
};

const renderAI=()=>{
  const a=aiAnalyze();
  if(!a)return;
  $('aiSuggestion').textContent='Suggestion : '+a.action;
  $('aiDetails').textContent=
    `Momentum ${a.momentum.toFixed(2)}% | Volatilité ${a.vol.toFixed(2)}%`;
};

const autoTrade=()=>{
  if(!state.auto)return;
  const a=aiAnalyze();
  if(!a)return;
  const c=state.companies[state.selected];
  if(a.action==='ACHETER')buy(c);
  if(a.action==='VENDRE')sell(c);
};

const renderAll=()=>{
  renderPortfolio();
  renderList();
  drawChart();
  renderChartInfo();
  renderStats();
  renderAI();
};

$('search').oninput=renderList;
$('autoToggle').checked=state.auto;
$('autoToggle').onchange=e=>{state.auto=e.target.checked;save()};

document.querySelectorAll('.tab').forEach(t=>{
  t.onclick=()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    ['chart','stats','ai'].forEach(id=>{
      $(id+'Tab').style.display=id===t.dataset.tab?'block':'none';
    });
  };
});

setInterval(()=>{
  updatePrices();
  autoTrade();
  renderAll();
  save();
},TICK);

renderAll();

})();
</script>
</body>
</html>
