<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Simulateur de Trading</title>

<style>
/* ===== THEME ===== */
body {
    margin: 0;
    font-family: Arial, Helvetica, sans-serif;
    background: #0e1117;
    color: #e5e7eb;
}

h2, h3 {
    margin: 0 0 10px 0;
}

.container {
    display: flex;
    height: 100vh;
}

/* ===== LEFT PANEL ===== */
.left {
    width: 45%;
    padding: 15px;
    overflow-y: auto;
}

.card {
    background: #161b22;
    border-radius: 12px;
    padding: 12px;
    margin-bottom: 12px;
}

/* ===== TOP STATS ===== */
.top-stats {
    display: flex;
    justify-content: space-between;
}

.stat {
    text-align: center;
}

.stat span {
    display: block;
    font-size: 14px;
    opacity: 0.7;
}

.stat strong {
    font-size: 18px;
}

/* ===== COMPANY LIST ===== */
.company {
    display: grid;
    grid-template-columns: 1fr 90px 70px 110px 120px;
    align-items: center;
    gap: 8px;
    padding: 8px;
    border-radius: 8px;
    cursor: pointer;
}

.company:hover {
    background: #1f2633;
}

.company.selected {
    background: #2563eb33;
}

.price {
    text-align: right;
}

.gain.pos { color: #22c55e; }
.gain.neg { color: #ef4444; }

/* ===== BUTTONS ===== */
button {
    border: none;
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
    font-weight: bold;
    transition: transform 0.1s, opacity 0.1s;
}

button:active {
    transform: scale(0.95);
}

.buy {
    background: #22c55e;
    color: #000;
}

.sell {
    background: #ef4444;
    color: #000;
}

button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

/* ===== RIGHT PANEL ===== */
.right {
    width: 55%;
    padding: 15px;
    display: flex;
    flex-direction: column;
}

canvas {
    background: #0b1220;
    border-radius: 12px;
}

/* ===== TABS ===== */
.tabs {
    display: flex;
    margin-bottom: 10px;
}

.tab {
    margin-right: 10px;
    padding: 6px 14px;
    border-radius: 8px;
    background: #1f2633;
    cursor: pointer;
}

.tab.active {
    background: #2563eb;
}

/* ===== STATS TABLE ===== */
table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 6px;
    text-align: right;
}

th {
    opacity: 0.7;
}

td:first-child, th:first-child {
    text-align: left;
}
</style>
</head>

<body>
<div class="tabs">
    <div class="tab active" id="tabTrading">Trading</div>
    <div class="tab" id="tabStats">Stats</div>
</div>

<div class="container">
    <div class="left" id="tradingView"></div>
    <div class="right">
        <canvas id="chart" width="700" height="350"></canvas>
        <div class="card" id="details"></div>
        <div class="card" id="statsView" style="display:none;"></div>
    </div>
</div>

<script>
/* ===================== DATA ===================== */
const STORAGE_KEY = "trading_sim_v1";
let capital = 2000;

const companiesDefault = [
    { name:"AlphaTech", price:50, vol:0.004 },
    { name:"GreenEnergy", price:40, vol:0.003 },
    { name:"MedLife", price:65, vol:0.002 },
    { name:"FinCorp", price:80, vol:0.003 },
    { name:"AutoDrive", price:55, vol:0.004 },
    { name:"Foodies", price:30, vol:0.002 },
    { name:"CloudNet", price:90, vol:0.004 },
    { name:"AeroSpace", price:120, vol:0.003 },
    { name:"RetailX", price:25, vol:0.005 },
    { name:"CryptoX", price:100, vol:0.05 } // très volatile
];

let companies = [];
let selected = 0;

/* ===================== LOAD / SAVE ===================== */
function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ capital, companies }));
}

function load() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (data) {
        const parsed = JSON.parse(data);
        capital = parsed.capital;
        companies = parsed.companies;
    } else {
        companies = companiesDefault.map(c => ({
            ...c,
            shares: 0,
            avg: 0,
            history: [c.price],
            buys: [],
            realized: 0,
            totalBuys: 0
        }));
    }
}
load();

/* ===================== MARKET ===================== */
function updatePrices() {
    companies.forEach(c => {
        const rnd = (Math.random() - 0.5) * c.vol;
        c.price *= (1 + rnd);
        c.price = Math.max(0.01, c.price);
        c.history.push(c.price);
        if (c.history.length > 500) c.history.shift();
    });
    save();
}

/* ===================== BUY / SELL ===================== */
function buy(i) {
    const c = companies[i];
    if (capital >= c.price) {
        capital -= c.price;
        c.avg = (c.avg * c.shares + c.price) / (c.shares + 1);
        c.shares++;
        c.totalBuys++;
        c.buys.push(c.history.length - 1);
        save();
    }
}

function sell(i) {
    const c = companies[i];
    if (c.shares > 0) {
        capital += c.price;
        c.realized += (c.price - c.avg);
        c.shares--;
        if (c.shares === 0) c.avg = 0;
        save();
    }
}

/* ===================== UI ===================== */
function renderTrading() {
    const view = document.getElementById("tradingView");
    view.innerHTML = "";

    const totalValue = capital + companies.reduce((s,c)=>s+c.shares*c.price,0);
    const totalGain = companies.reduce((s,c)=>s+c.realized+(c.price-c.avg)*c.shares,0);

    view.innerHTML += `
    <div class="card top-stats">
        <div class="stat"><span>Capital</span><strong>${capital.toFixed(2)} €</strong></div>
        <div class="stat"><span>Portefeuille</span><strong>${totalValue.toFixed(2)} €</strong></div>
        <div class="stat"><span>Gain global</span><strong class="${totalGain>=0?'gain pos':'gain neg'}">${totalGain.toFixed(2)} €</strong></div>
    </div>`;

    companies.forEach((c,i)=>{
        const latent = (c.price - c.avg) * c.shares;
        view.innerHTML += `
        <div class="company ${i===selected?'selected':''}" onclick="selectCompany(${i})">
            <div>${c.name}</div>
            <div class="price">${c.price.toFixed(2)} €</div>
            <div>${c.shares}</div>
            <div class="gain ${latent>=0?'pos':'neg'}">${latent.toFixed(2)} €</div>
            <div>
                <button class="buy" onclick="event.stopPropagation();buy(${i})">Acheter</button>
                <button class="sell" onclick="event.stopPropagation();sell(${i})">Vendre</button>
            </div>
        </div>`;
    });
}

function selectCompany(i){
    selected = i;
}

/* ===================== CHART ===================== */
const canvas = document.getElementById("chart");
const ctx = canvas.getContext("2d");

function drawChart() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const c = companies[selected];
    const windowSize = 60;
    const data = c.history.slice(-windowSize);

    let min = Math.min(...data);
    let max = Math.max(...data);
    const margin = (max-min)*0.1 || 1;
    min -= margin; max += margin;

    const clamp = v => Math.max(min, Math.min(max, v));

    ctx.strokeStyle = "#3b82f6";
    ctx.beginPath();
    data.forEach((p,i)=>{
        const x = i/(windowSize-1)*canvas.width;
        const y = canvas.height - (clamp(p)-min)/(max-min)*canvas.height;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // buy points
    ctx.fillStyle = "#22c55e";
    c.buys.forEach(b=>{
        if(b >= c.history.length-windowSize){
            const i = b-(c.history.length-windowSize);
            const p = data[i];
            const x = i/(windowSize-1)*canvas.width;
            const y = canvas.height - (clamp(p)-min)/(max-min)*canvas.height;
            ctx.beginPath();
            ctx.arc(x,y,4,0,Math.PI*2);
            ctx.fill();
        }
    });

    // current price line
    const y = canvas.height - (clamp(c.price)-min)/(max-min)*canvas.height;
    ctx.strokeStyle = "#ffffff55";
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
    ctx.stroke();
}

/* ===================== DETAILS ===================== */
function renderDetails() {
    const c = companies[selected];
    const latent = (c.price - c.avg) * c.shares;
    document.getElementById("details").innerHTML = `
        <h3>${c.name}</h3>
        Prix actuel : ${c.price.toFixed(2)} €<br>
        Prix moyen : ${c.avg.toFixed(2)} €<br>
        Parts : ${c.shares}<br>
        Gain latent : <span class="${latent>=0?'gain pos':'gain neg'}">${latent.toFixed(2)} €</span>
    `;
}

/* ===================== STATS ===================== */
function renderStats(){
    let html = `<h3>Statistiques</h3><table>
    <tr><th>Entreprise</th><th>Parts achetées</th><th>Réalisé</th><th>Latent</th><th>Total</th></tr>`;
    companies.forEach(c=>{
        const latent = (c.price - c.avg) * c.shares;
        const total = latent + c.realized;
        html += `
        <tr>
            <td>${c.name}</td>
            <td>${c.totalBuys}</td>
            <td class="${c.realized>=0?'gain pos':'gain neg'}">${c.realized.toFixed(2)}</td>
            <td class="${latent>=0?'gain pos':'gain neg'}">${latent.toFixed(2)}</td>
            <td class="${total>=0?'gain pos':'gain neg'}">${total.toFixed(2)}</td>
        </tr>`;
    });
    html += "</table>";
    document.getElementById("statsView").innerHTML = html;
}

/* ===================== TABS ===================== */
tabTrading.onclick = ()=>{
    tradingView.style.display="block";
    statsView.style.display="none";
    tabTrading.classList.add("active");
    tabStats.classList.remove("active");
};

tabStats.onclick = ()=>{
    tradingView.style.display="none";
    statsView.style.display="block";
    tabStats.classList.add("active");
    tabTrading.classList.remove("active");
};

/* ===================== LOOP ===================== */
setInterval(()=>{
    updatePrices();
    renderTrading();
    renderDetails();
    renderStats();
    drawChart();
},300);
</script>
</body>
</html>
